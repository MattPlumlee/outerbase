<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="outerbase">
<title>Learning from data • outerbase</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><link href="../deps/_Source%20Sans%20Pro-0.4.1/font.css" rel="stylesheet">
<link href="../deps/_Source%20Code%20Pro-0.4.1/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Learning from data">
<meta property="og:description" content="outerbase">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">outerbase</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/gettingstarted.html">Get Started</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-elements">Elements</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-elements">
    <a class="dropdown-item" href="../articles/basebasics.html">Models and Bases</a>
    <a class="dropdown-item" href="../articles/learning.html">Learning</a>
    <a class="dropdown-item" href="../articles/speed.html">Speed</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Versions</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/MattPlumlee/outerbase/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Learning from data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/MattPlumlee/outerbase/blob/HEAD/vignettes/learning.Rmd" class="external-link"><code>vignettes/learning.Rmd</code></a></small>
      <div class="d-none name"><code>learning.Rmd</code></div>
    </div>

    
    
<p>This page is designed to explain how <code><a href="../reference/lpdf.html">?lpdf</a></code> objects can be used for automated learning of hyperparameters and general fitting of predictors.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mattplumlee.github.io/outerbase">outerbase</a></span><span class="op">)</span></code></pre></div>
<p>Let’s set things up for a 3 dimensional example.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">om</span> <span class="op">=</span> <span class="fu">new</span><span class="op">(</span><span class="va">outermod</span><span class="op">)</span>
<span class="fu"><a href="../reference/setcovfs.html">setcovfs</a></span><span class="op">(</span><span class="va">om</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"mat25pow"</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="va">knotlist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="fl">0.99</span>,by<span class="op">=</span><span class="fl">0.02</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="fl">0.99</span>,by<span class="op">=</span><span class="fl">0.02</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="fl">0.99</span>,by<span class="op">=</span><span class="fl">0.02</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="../reference/setknot.html">setknot</a></span><span class="op">(</span><span class="va">om</span>, <span class="va">knotlist</span><span class="op">)</span></code></pre></div>
<div class="section level2">
<h2 id="hyperparameter-impact">Hyperparameter impact<a class="anchor" aria-label="anchor" href="#hyperparameter-impact"></a>
</h2>
<p>The values of hyperparameters are extremely important for successful near-interpolation of surfaces. This impact is felt in <code>outerbase</code> and this section is designed to illustrate that.</p>
<p>Let’s take a look at the projected basis functions.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sampsize</span> <span class="op">=</span> <span class="fl">100</span>
<span class="va">design1d</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">sampsize</span><span class="op">)</span>,<span class="fl">1</span><span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">sampsize</span><span class="op">)</span>,<span class="fl">1</span><span class="op">/</span><span class="va">sampsize</span><span class="op">)</span>
<span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">design1d</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">design1d</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">design1d</span><span class="op">)</span><span class="op">)</span>
<span class="va">ob</span> <span class="op">=</span> <span class="fu">new</span><span class="op">(</span><span class="va">outerbase</span>, <span class="va">om</span>, <span class="va">x</span><span class="op">)</span>
<span class="va">basis_func0</span> <span class="op">=</span> <span class="va">ob</span><span class="op">$</span><span class="fu">getbase</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">basis_func0</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, 
        type<span class="op">=</span><span class="st">'l'</span>, ylab<span class="op">=</span><span class="st">"func"</span>, xlab<span class="op">=</span><span class="st">"first dim"</span><span class="op">)</span></code></pre></div>
<p><img src="learning_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>The hyperparameters will now be changed in a way that I know will change these basis functions. Note that <code>ob$build</code> is required after updating the hyperparameters for it to take effect.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hyp0</span> <span class="op">=</span> <span class="fu"><a href="../reference/gethyp.html">gethyp</a></span><span class="op">(</span><span class="va">om</span><span class="op">)</span>
<span class="va">hyp0</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="fl">3</span> <span class="co">#changing the power on first parameter</span>
<span class="va">om</span><span class="op">$</span><span class="fu">updatehyp</span><span class="op">(</span><span class="va">hyp0</span><span class="op">)</span>
<span class="va">ob</span><span class="op">$</span><span class="fu">build</span><span class="op">(</span><span class="op">)</span> <span class="co">#rebuild after updatehyp</span></code></pre></div>
<p>This leads to an asymmetric basis function set for this first dimension because of the power transform in <code><a href="../reference/covf_mat25pow.html">?covf_mat25pow</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">basis_func1</span> <span class="op">=</span> <span class="va">ob</span><span class="op">$</span><span class="fu">getbase</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">basis_func0</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, 
        type<span class="op">=</span><span class="st">'l'</span>, ylab<span class="op">=</span><span class="st">"func"</span>, xlab<span class="op">=</span><span class="st">"first dim"</span>,
        main<span class="op">=</span><span class="st">"original hyperparameters"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">basis_func1</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, 
        type<span class="op">=</span><span class="st">'l'</span>, ylab<span class="op">=</span><span class="st">"func"</span>, xlab<span class="op">=</span><span class="st">"first dim"</span>,
        main<span class="op">=</span><span class="st">"new hyperparameters"</span><span class="op">)</span></code></pre></div>
<p><img src="learning_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="lpdf-for-learning">lpdf for learning<a class="anchor" aria-label="anchor" href="#lpdf-for-learning"></a>
</h2>
<p>The core building block for outerbase learning is the base class <code><a href="../reference/lpdf.html">?lpdf</a></code>, log probability density functions. This base class forms the backbone behind many possible statistical models. Instances of this class allow us to optimize coefficients, infer on uncertainty and learn hyperparmeters of covariance functions.</p>
<p>A small dataset can illustrate (almost) all core concepts related to <code>lpdf</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sampsize</span> <span class="op">=</span> <span class="fl">30</span>
<span class="va">d</span> <span class="op">=</span> <span class="fl">3</span>
<span class="va">design1d</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">sampsize</span><span class="op">)</span>,<span class="fl">1</span><span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">sampsize</span><span class="op">)</span>,<span class="fl">1</span><span class="op">/</span><span class="va">sampsize</span><span class="op">)</span>
<span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">design1d</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">design1d</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">design1d</span><span class="op">)</span><span class="op">)</span>
<span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="../reference/obtest_borehole3d.html">obtest_borehole3d</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></code></pre></div>
<p>We can reset our our hyperparameters here, which is 2 dimensions for each covariance function for a total of 6 hyperparameters.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hyp0</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>,<span class="fl">0</span>,<span class="op">-</span><span class="fl">0.5</span>,<span class="fl">0</span>,<span class="op">-</span><span class="fl">0.5</span>,<span class="fl">0</span><span class="op">)</span>
<span class="va">om</span><span class="op">$</span><span class="fu">updatehyp</span><span class="op">(</span><span class="va">hyp0</span><span class="op">)</span>
<span class="va">hyp0</span> <span class="op">=</span> <span class="fu"><a href="../reference/gethyp.html">gethyp</a></span><span class="op">(</span><span class="va">om</span><span class="op">)</span></code></pre></div>
<p>We will use <code>60</code> terms here to build our approximation.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p</span> <span class="op">=</span> <span class="fl">60</span>
<span class="va">terms</span> <span class="op">=</span> <span class="va">om</span><span class="op">$</span><span class="fu">selectterms</span><span class="op">(</span><span class="va">p</span><span class="op">)</span></code></pre></div>
<p>The idea is to build a <code>loglik</code> object that represent that log likelihood of our data given the model and coefficients. We will begin with <code><a href="../reference/loglik_std.html">?loglik_std</a></code>, although this model is not recommended for speed reasons. We can initialize it and check that we can get gradients with respect to coefficients, covariance hyperparameters, and parameters of the <code>lpdf</code> object itself.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">loglik</span> <span class="op">=</span> <span class="fu">new</span><span class="op">(</span><span class="va">loglik_std</span>, <span class="va">om</span>, <span class="va">terms</span>, <span class="va">y</span>, <span class="va">x</span><span class="op">)</span> 
<span class="va">coeffhere</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">loglik</span><span class="op">$</span><span class="va">nterms</span><span class="op">)</span>
<span class="va">loglik</span><span class="op">$</span><span class="fu">update</span><span class="op">(</span><span class="va">coeffhere</span><span class="op">)</span> <span class="co"># update it to get gradients</span>
<span class="va">loglik</span><span class="op">$</span><span class="va">val</span>
<span class="co">#&gt; [1] -157.2298</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">loglik</span><span class="op">$</span><span class="va">grad</span><span class="op">)</span> <span class="co"># dim 60 for number of coeffients</span>
<span class="co">#&gt;             [,1]</span>
<span class="co">#&gt; [1,]  0.06132942</span>
<span class="co">#&gt; [2,]  2.45174651</span>
<span class="co">#&gt; [3,] -1.05830556</span>
<span class="co">#&gt; [4,] -0.59334205</span>
<span class="co">#&gt; [5,] -0.06994568</span>
<span class="co">#&gt; [6,] -0.07238581</span></code></pre></div>
<p>A reasonable predictor also needs prior on the coefficients. This tells us what distribution we expect on the coefficients.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">logpr</span> <span class="op">=</span> <span class="fu">new</span><span class="op">(</span><span class="va">logpr_gauss</span>, <span class="va">om</span>, <span class="va">terms</span><span class="op">)</span></code></pre></div>
<p>To make the handling of these two objects <code>loglik</code> and <code>logpr</code> easier, the <code><a href="../reference/lpdfvec.html">?lpdfvec</a></code> class is helpful to tie the object together. It will share the hyperparameter vector between them, so they need to be based on the same <code>outermod</code> object. But it will concatenate the parameters.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">logpdf</span> <span class="op">=</span> <span class="fu">new</span><span class="op">(</span><span class="va">lpdfvec</span>, <span class="va">loglik</span>, <span class="va">logpr</span><span class="op">)</span>
<span class="va">para0</span> <span class="op">=</span> <span class="fu"><a href="../reference/getpara.html">getpara</a></span><span class="op">(</span><span class="va">logpdf</span><span class="op">)</span>
<span class="va">para0</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="fl">4</span>
<span class="va">logpdf</span><span class="op">$</span><span class="fu">updatepara</span><span class="op">(</span><span class="va">para0</span><span class="op">)</span>
<span class="fu"><a href="../reference/getpara.html">getpara</a></span><span class="op">(</span><span class="va">logpdf</span><span class="op">)</span>
<span class="co">#&gt; noisescale coeffscale </span>
<span class="co">#&gt;   3.135555   4.000000</span></code></pre></div>
<p>The coefficients <code>coeff</code> are considered ancillary parameters that need to be optimized out (or something more sophisticated, hint on current research). For this class, it is easiest to do this via <code>lpdf$optnewton</code>, which takes a single Newton step to optimize the coefficients.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">logpdf</span><span class="op">$</span><span class="fu">optnewton</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Some test data will help illustrate prediction.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">testsampsize</span> <span class="op">=</span> <span class="fl">1000</span>
<span class="va">xtest</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">testsampsize</span><span class="op">*</span><span class="va">d</span><span class="op">)</span>,ncol<span class="op">=</span><span class="va">d</span><span class="op">)</span>
<span class="va">ytest</span> <span class="op">=</span> <span class="fu"><a href="../reference/obtest_borehole3d.html">obtest_borehole3d</a></span><span class="op">(</span><span class="va">xtest</span><span class="op">)</span></code></pre></div>
<p>We can see the predictive accuracy using the <code><a href="../reference/predictor.html">?predictor</a></code> class which automatically pulls correct information out of <code>loglik</code> to design predictions.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predt</span> <span class="op">=</span> <span class="fu">new</span><span class="op">(</span><span class="va">predictor</span>,<span class="va">loglik</span><span class="op">)</span>
<span class="va">predt</span><span class="op">$</span><span class="fu">update</span><span class="op">(</span><span class="va">xtest</span><span class="op">)</span>
<span class="va">yhat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">predt</span><span class="op">$</span><span class="fu">mean</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">varpred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">predt</span><span class="op">$</span><span class="fu">var</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">yhat</span>,<span class="va">ytest</span>, xlab<span class="op">=</span><span class="st">"prediction"</span>, ylab<span class="op">=</span><span class="st">"actual"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="op">(</span><span class="va">ytest</span><span class="op">-</span><span class="va">yhat</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">varpred</span><span class="op">)</span>,
     main<span class="op">=</span><span class="st">"standarized test residuals"</span>,
     xlab <span class="op">=</span> <span class="st">"standarized test residuals"</span><span class="op">)</span></code></pre></div>
<p><img src="learning_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="lpdf-and-hyperparameters">lpdf and hyperparameters<a class="anchor" aria-label="anchor" href="#lpdf-and-hyperparameters"></a>
</h2>
<p>The main value in this approach is the automated pulling of important gradients related to covariance hyperparameters and model parameters.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">logpdf</span><span class="op">$</span><span class="fu">optnewton</span><span class="op">(</span><span class="op">)</span>
<span class="va">logpdf</span><span class="op">$</span><span class="va">gradhyp</span>    <span class="co"># dim 6 for all hyperparameter</span>
<span class="co">#&gt;            [,1]</span>
<span class="co">#&gt; [1,] -1.8646843</span>
<span class="co">#&gt; [2,]  0.1367914</span>
<span class="co">#&gt; [3,]  7.7118090</span>
<span class="co">#&gt; [4,]  0.8386114</span>
<span class="co">#&gt; [5,]  6.4551161</span>
<span class="co">#&gt; [6,]  0.6441583</span>
<span class="va">logpdf</span><span class="op">$</span><span class="va">gradpara</span>   <span class="co"># dim 2 since 2 parameters</span>
<span class="co">#&gt;            [,1]</span>
<span class="co">#&gt; [1,] -18.571921</span>
<span class="co">#&gt; [2,]  -1.800939</span></code></pre></div>
<p>This allows us to use custom functions to learn these hyperparameters to give maximum predictive power. The goal right now is a single point estimate of these hyperparameters. One has to be very careful to keep these in good ranges, and the call below will make sure to return <code>-inf</code> if there is a problem with the chosen hyperparameters.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">totobj</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">hypl</span><span class="op">)</span> <span class="op">{</span> <span class="co">#my optimization function for tuning</span>
  <span class="va">regpara</span> <span class="op">=</span> <span class="va">logpdf</span><span class="op">$</span><span class="fu">paralpdf</span><span class="op">(</span><span class="va">hypl</span><span class="op">$</span><span class="va">para</span><span class="op">)</span> <span class="co"># get regularization for lpdf</span>
  <span class="va">reghyp</span> <span class="op">=</span> <span class="va">om</span><span class="op">$</span><span class="fu">hyplpdf</span><span class="op">(</span><span class="va">hypl</span><span class="op">$</span><span class="va">hyp</span><span class="op">)</span> <span class="co"># get regularization for om</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">regpara</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">reghyp</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co"># if they pass</span>
    <span class="va">om</span><span class="op">$</span><span class="fu">updatehyp</span><span class="op">(</span><span class="va">hypl</span><span class="op">$</span><span class="va">hyp</span><span class="op">)</span>        <span class="co"># update hyperparameters</span>
    <span class="va">logpdf</span><span class="op">$</span><span class="fu">updateom</span><span class="op">(</span><span class="op">)</span>             <span class="co"># update the outerbase inside</span>
    <span class="va">logpdf</span><span class="op">$</span><span class="fu">updatepara</span><span class="op">(</span><span class="va">hypl</span><span class="op">$</span><span class="va">para</span><span class="op">)</span>  <span class="co"># update parameter</span>
    <span class="va">logpdf</span><span class="op">$</span><span class="fu">optnewton</span><span class="op">(</span><span class="op">)</span>            <span class="co"># do opt</span>
    
    <span class="va">gval</span> <span class="op">=</span> <span class="va">hypl</span> <span class="co">#match structure</span>
    <span class="va">gval</span><span class="op">$</span><span class="va">hyp</span> <span class="op">=</span> <span class="op">-</span><span class="va">logpdf</span><span class="op">$</span><span class="va">gradhyp</span><span class="op">-</span><span class="va">om</span><span class="op">$</span><span class="fu">hyplpdf_grad</span><span class="op">(</span><span class="va">hypl</span><span class="op">$</span><span class="va">hyp</span><span class="op">)</span>
    <span class="va">gval</span><span class="op">$</span><span class="va">para</span> <span class="op">=</span> <span class="op">-</span><span class="va">logpdf</span><span class="op">$</span><span class="va">gradpara</span><span class="op">-</span><span class="va">logpdf</span><span class="op">$</span><span class="fu">paralpdf_grad</span><span class="op">(</span><span class="va">hypl</span><span class="op">$</span><span class="va">para</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>val <span class="op">=</span> <span class="op">-</span><span class="va">logpdf</span><span class="op">$</span><span class="va">val</span><span class="op">-</span><span class="va">reghyp</span><span class="op">-</span><span class="va">regpara</span>, gval <span class="op">=</span> <span class="va">gval</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>val <span class="op">=</span> <span class="cn">Inf</span>, gval <span class="op">=</span> <span class="va">hypl</span><span class="op">)</span> <span class="op">}</span></code></pre></div>
<p>This works by pulling the right information and checking to make sure the objects themselves thing the parameters are reasonable. This package provides a custom deployment of <code>BFGS</code> in <code><a href="../reference/BFGS_std.html">?BFGS_std</a></code> to optimize functions like this.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hypl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>para <span class="op">=</span> <span class="fu"><a href="../reference/getpara.html">getpara</a></span><span class="op">(</span><span class="va">logpdf</span><span class="op">)</span>, hyp <span class="op">=</span> <span class="fu"><a href="../reference/gethyp.html">gethyp</a></span><span class="op">(</span><span class="va">om</span><span class="op">)</span><span class="op">)</span>
<span class="fu">totobj</span><span class="op">(</span><span class="va">hypl</span><span class="op">)</span>
<span class="co">#&gt; $val</span>
<span class="co">#&gt; [1] 88.35303</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $gval</span>
<span class="co">#&gt; $gval$para</span>
<span class="co">#&gt;           [,1]</span>
<span class="co">#&gt; [1,] 18.571921</span>
<span class="co">#&gt; [2,]  1.300939</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $gval$hyp</span>
<span class="co">#&gt;             [,1]</span>
<span class="co">#&gt; [1,]  -3.4924586</span>
<span class="co">#&gt; [2,]  -0.1367914</span>
<span class="co">#&gt; [3,] -13.0689519</span>
<span class="co">#&gt; [4,]  -0.8386114</span>
<span class="co">#&gt; [5,] -11.8122590</span>
<span class="co">#&gt; [6,]  -0.6441583</span>
<span class="va">opth</span> <span class="op">=</span> <span class="fu"><a href="../reference/BFGS_std.html">BFGS_std</a></span><span class="op">(</span><span class="va">totobj</span>, <span class="va">hypl</span>, verbose<span class="op">=</span><span class="fl">3</span><span class="op">)</span> <span class="co">#</span>
<span class="co">#&gt; [1] "doing opt..."</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1]  -2.547346 -44.730643</span>
<span class="co">#&gt; [1] 85.80519</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1] -1.0413926  0.7758913</span>
<span class="co">#&gt; [1] 78.20374</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1] -11.12319 -66.97596</span>
<span class="co">#&gt; [1] 67.0771</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1]  -9.64457 -25.53975</span>
<span class="co">#&gt; [1] 57.43011</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1] -6.9248556 -0.6495823</span>
<span class="co">#&gt; [1] 50.50449</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1] -17.03187 -36.15836</span>
<span class="co">#&gt; [1] 33.46899</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1]  0.1494127 -7.0986601</span>
<span class="co">#&gt; [1] 32.55157</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1] -0.1449747 -0.1837861</span>
<span class="co">#&gt; [1] 32.40658</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1] -0.03382053 -0.03293540</span>
<span class="co">#&gt; [1] "finished opt..."</span></code></pre></div>
<p>Then we just have to update out parameters and re-optimize.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">om</span><span class="op">$</span><span class="fu">updatehyp</span><span class="op">(</span><span class="va">opth</span><span class="op">$</span><span class="va">vec</span><span class="op">$</span><span class="va">hyp</span><span class="op">)</span>
<span class="va">logpdf</span><span class="op">$</span><span class="fu">updatepara</span><span class="op">(</span><span class="va">opth</span><span class="op">$</span><span class="va">vec</span><span class="op">$</span><span class="va">para</span><span class="op">)</span>
<span class="va">logpdf</span><span class="op">$</span><span class="fu">optnewton</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>These steps can all be nicely wrapped up in another function <code><a href="../reference/BFGS_lpdf.html">?BFGS_lpdf</a></code>, which is a simpler call with the same result. Note because of some things not fully understood, these numbers will not match <em>exactly</em> above, but will be quite close and functionally the same.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">opth</span> <span class="op">=</span> <span class="fu"><a href="../reference/BFGS_lpdf.html">BFGS_lpdf</a></span><span class="op">(</span><span class="va">om</span>, <span class="va">logpdf</span>, 
                 rho<span class="op">=</span><span class="va">hypl</span>, 
                 verbose <span class="op">=</span> <span class="fl">3</span>, newt<span class="op">=</span> <span class="cn">T</span><span class="op">)</span>  
<span class="co">#&gt; [1] "doing opt..."</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1]  -2.547346 -44.730643</span>
<span class="co">#&gt; [1] 85.80519</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1] -1.0413926  0.7758913</span>
<span class="co">#&gt; [1] 78.20374</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1] -11.12319 -66.97596</span>
<span class="co">#&gt; [1] 67.0771</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1]  -9.64457 -25.53975</span>
<span class="co">#&gt; [1] 57.43011</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1] -6.9248556 -0.6495823</span>
<span class="co">#&gt; [1] 50.50449</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1] -17.03187 -36.15836</span>
<span class="co">#&gt; [1] 33.46899</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1]  0.1494127 -7.0986601</span>
<span class="co">#&gt; [1] 30.90201</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1]  1.4977785 -0.6609533</span>
<span class="co">#&gt; [1] 32.55157</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1]   614.3913 -3656.5915</span>
<span class="co">#&gt; [1] 32.45716</span>
<span class="co">#&gt; [1] "Wolfe conditions"</span>
<span class="co">#&gt; [1] -0.001331536  0.006470923</span>
<span class="co">#&gt; [1] "finished opt..."</span></code></pre></div>
<p>The revised predictions are then built after hyperparameter optimization where we find improved predictive accuracy in nearly every category.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predtt</span> <span class="op">=</span> <span class="fu">new</span><span class="op">(</span><span class="va">predictor</span>,<span class="va">loglik</span><span class="op">)</span>
<span class="va">predtt</span><span class="op">$</span><span class="fu">update</span><span class="op">(</span><span class="va">xtest</span><span class="op">)</span>
<span class="va">yhat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">predtt</span><span class="op">$</span><span class="fu">mean</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">varpred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">predtt</span><span class="op">$</span><span class="fu">var</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ytest</span>,<span class="va">yhat</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="op">(</span><span class="va">ytest</span><span class="op">-</span><span class="va">yhat</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">varpred</span><span class="op">)</span>, main<span class="op">=</span><span class="st">"standarized test residuals"</span>,
     xlab <span class="op">=</span> <span class="st">"standarized test residuals"</span><span class="op">)</span></code></pre></div>
<p><img src="learning_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Matthew Plumlee.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
